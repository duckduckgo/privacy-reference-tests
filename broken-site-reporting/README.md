# Broken Site Reporting Tests

Privacy Feature: https://app.asana.com/0/1198207348643509/1200191185434196/f

## Goals

This set of tests verifies implementation of broken site reporting. In particular it focuses on verifying that the report generated is sent to a correct url and includes all data needed (which differs between platforms).

## Structure

Test suite specific fields:

- `siteURL` - string - currently loaded website's URL (as seen in the URL bar)
- `wasUpgraded` - bool - if request was upgraded to HTTPS by us or not
- `category` - string - user picked breakage category e.g. 'content', 'images', 'paywall', 'login'
- `blockedTrackers` - array of strings - array of hostnames of trackers that were blocked
- `noActionRequests` - array of strings - array of hostnames of requests that were not on the blocklist
- `adAttributionRequests` - array of strings - array of hostnames of requests that were ignored due to ad-attribution
- `ignoredByUserRequests` - array of strings - array of hostnames of requests that were allowed due to protections disabled by the user
- `ignoreRequests` - array of strings - array of hostnames of requests that were ignored for other reasons (e.g., blocklist ignore)
- `surrogates` - array of strings - array of hostnames of trackers that were replaced with a surrogate
- `atb` - string - ATB cohort
- `blocklistVersion` - string - version of the blocklist
- `manufacturer` - string - name of the device manufacturer (native apps only)
- `model` - string - name of the device model (native apps only)
- `os` - string - operating system name (native apps only)
- `gpcEnabled` - boolean - if GPC is enabled or not (native apps only) - GPC can be disabled by user or by remote config
- `errorDescriptions` - array of strings - optional field containing descriptions from errors generated by failed page loads
- `httpErrorCodes` - array of int - optional field containing the HTTP status codes returned by the page load
- `expectReportURLPrefix` - string - resulting report URL should be prefixed with this string
- `expectReportURLParams` - Array of `{name: '', value: ''}` objects - resulting report URL should have the following set of URL parameters with matching values
    - `value` is an optional check for an exact value match.
    - `match` is an optional check for a regex match.
    - `present` is an optional check for the presence of a parameter.
    - `matchesCurrentDay` is an optional check that the provided value is the current day when the test is ran (e.g., `2023-11-01`).
- `remoteConfigEtag` - string - string representation of remote configuration etag
- `remoteConfigVersion` - string - string representation of remote configuration version (note, this is the numeric version found in the remote config (e.g, `1680178584671`, not `v1` or `v2`))
- `providedDescription` - string - user-provided breakage description
- `protectionsEnabled` - boolean - if protections are enabled (true) or disabled (false) as visible to the user on the dashboard.

All of these custom fields are supported by the `reports` array objects within the multiple_report_tests.json file.

## Pseudo-code implementation

```
for $testSet in test.json

  for $test in $testSet
    if $test.exceptPlatforms includes 'current-platform'
        skip

    $url = getReportURL(
        siteURL=$test.siteURL,
        wasUpgraded=$test.wasUpgraded,
        reportCategory=$test.category,
        blockedTrackers=$test.blockedTrackers,
        surrogates=$test.surrogates,
        atb=$test.atb,
        blocklistVersion=$test.blocklistVersion,
        manufacturer=$test.manufacturer,
        model=$test.model,
        os=$test.os,
        gpcEnabled=$test.gpcEnabled
    )

    if $test.expectReportURLPrefix
        expect($url.startsWith($test.expectReportURLPrefix))

    if $test.expectReportURLParams
        for $param in $test.expectReportURLParams
            if $param.value
                expect($url.matchesRegex(/[?&] + $param.name + '=' + $param.value + [&$]/))
            if $param.match
                $value = findParamValue($url, $param.name)
                expect($value.matchesRegex($param.match))
            if $param.present
                expect($url.matchesRegex(/[?&] + $param.name + '=[^&]*[&$]/))
            if $param.matchesCurrentDay
                $value = findParamValue($url, $param.name)
                expect($value = getCurrentDay())
```

For multiple_report_tests.json:

```
for $testSet in test.json

  for $test in $testSet
      if $test.exceptPlatforms includes 'current-platform'
          skip

      for $report in $testSet.reports
        $url = getReportURL(
            siteURL=$report.siteURL,
            wasUpgraded=$report.wasUpgraded,
            reportCategory=$report.category,
            blockedTrackers=$report.blockedTrackers,
            surrogates=$report.surrogates,
            atb=$report.atb,
            blocklistVersion=$report.blocklistVersion,
            manufacturer=$report.manufacturer,
            model=$report.model,
            os=$report.os,
            gpcEnabled=$report.gpcEnabled
        )

        if $report.expectReportURLPrefix
            expect($url.startsWith($report.expectReportURLPrefix))

        if $report.expectReportURLParams
            for $param in $report.expectReportURLParams
                if $param.value
                    expect($url.matchesRegex(/[?&] + $param.name + '=' + $param.value + [&$]/))
                if $param.match
                    $value = findParamValue($url, $param.name)
                    expect($value.matchesRegex($param.match))
                if $param.present
                    expect($url.matchesRegex(/[?&] + $param.name + '=[^&]*[&$]/))
                if $param.matchesCurrentDay
                    $value = findParamValue($url, $param.name)
                    expect($value = getCurrentDay())
```

## Platform exceptions

Please see https://app.asana.com/0/1198207348643509/1200191185434196/f for
current platform support and further links. A summary of exceptions affecting
the reference tests is provided below:

- description tests:
  - the following platforms do not currently allow users to provide a description:
    - `android-browser`, see https://app.asana.com/0/1163321984198618/1203936449485101/f
    - `ios-browser`, see https://app.asana.com/0/1163321984198618/1203944813756141
    - `safari-extension`, see https://app.asana.com/0/1201602070177732/1204307004967346
- the following platforms don't yet encode etags in the expected manner
  - `ios-browser`, see https://app.asana.com/0/0/1204852947979442/f
- the following platforms don't yet send privacy configuration version information in reports:
  - `ios-browser`, see https://app.asana.com/0/0/1204370595704517/f
- truncation tests:
  - the following platforms do not currently implement the optional `noActionRequests`, `adAttributionRequests`, `ignoredByUserRequests`, or `ignoreRequests` truncatable parameters: `android-browser`, `ios-browser`, `macos-browser`, `safari-extension`, `windows-browser`
  - see https://app.asana.com/0/0/1204271046995906/f for more information about truncation and implementation requirements
- param `protectionsState`
  - The Extension is the only platform that supports a 'denylist' - this allows a user to override remote configurations and forcibly enable protections even when we've tried to disable them.
    - For this case, an extension-only case was added in `broken-site-reporting/tests.json` 
